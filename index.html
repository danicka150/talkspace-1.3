<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TalkSpace üí¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-screen {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            width: 400px;
            text-align: center;
        }

        .auth-title {
            font-size: 28px;
            margin-bottom: 10px;
            color: #333;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-error {
            color: #e74c3c;
            margin-top: 15px;
            min-height: 20px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
        .app-screen {
            display: none;
            width: 1000px;
            height: 700px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            font-size: 24px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ */
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* –°–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
.user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s;
            gap: 12px;
        }

        .user-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
        }

        .user-avatar {
            font-size: 24px;
        }

        .user-name {
            font-weight: bold;
            flex: 1;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin: 10px 0;
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 70%;
            animation: messageAppear 0.3s ease;
        }

        .message.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.other {
            background: white;
            border: 1px solid #dee2e6;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 25px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .message-input input:focus {
            border-color: #667eea;
            outline: none;
        }

        .send-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* –ü–æ–∏—Å–∫ */
        .search-box {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e1e1e1;
            border-radius: 25px;
            font-size: 14px;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-style: italic;
        }

        /* –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è */
        .friend-request {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }
.accept-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
        }

        .decline-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-title">üí¨ TalkSpace</div>
        <div class="auth-subtitle">–í–∞—à–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
        
        <input type="text" class="auth-input" id="usernameInput" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        <input type="password" class="auth-input" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
        
        <button class="auth-btn" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <button class="auth-btn" onclick="login()">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</button>
        
        <div class="auth-error" id="authError"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app-screen" id="appScreen">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="app-header">
            <div class="user-info">
                <span class="user-avatar" id="userAvatar">üòé</span>
                <span id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
            </div>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('friends')">üë• –î—Ä—É–∑—å—è</button>
            <button class="tab-btn" onclick="openTab('search')">üîç –ü–æ–∏—Å–∫</button>
            <button class="tab-btn" onclick="openTab('global')">üåç –û–±—â–∏–π —á–∞—Ç</button>
            <button class="tab-btn" onclick="openTab('requests')">üì® –ó–∞–ø—Ä–æ—Å—ã</button>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="app-content">
            <!-- –í–∫–ª–∞–¥–∫–∞ –î—Ä—É–∑—å—è -->
            <div id="friendsTab" class="tab-content active">
                <div class="user-list" id="friendsList">
                    <div class="empty-state">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>
                </div>
                <div class="messages-container" id="privateChat" style="display: none;">
                    <div class="chat-header" id="chatWith">–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</div>
                    <div class="messages" id="privateMessages"></div>
                    <div class="message-input">
                        <input type="text" id="privateMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button class="send-btn" onclick="sendPrivateMessage()">‚û§</button>
                    </div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–∏—Å–∫ -->
            <div id="searchTab" class="tab-content">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." oninput="searchUsers()">
                </div>
                <div class="user-list" id="searchResults">
                    <div class="empty-state">–ù–∞—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –û–±—â–∏–π —á–∞—Ç -->
            <div id="globalTab" class="tab-content">
                <div class="messages-container">
                    <div class="chat-header">üåç –û–±—â–∏–π —á–∞—Ç TalkSpace</div>
                    <div class="messages" id="globalMessages"></div>
                    <div class="message-input">
                        <input type="text" id="globalMessageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—â–∏–π —á–∞—Ç...">
                        <button class="send-btn" onclick="sendGlobalMessage()">‚û§</button>
                    </div>
                </div>
            </div>
<!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è -->
            <div id="requestsTab" class="tab-content">
                <div class="user-list" id="requestsList">
                    <div class="empty-state">–ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥—Ä—É–∑—å—è –Ω–µ—Ç</div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        const socket = io();
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentUser = null;
        let currentChat = null;
        let friends = [];

        // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function register() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (username && password) {
                socket.emit('register', { username, password });
            } else {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            }
        }

        function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (username && password) {
                socket.emit('login', { username, password });
            } else {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            }
        }

        function logout() {
            currentUser = null;
            friends = [];
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('appScreen').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function openTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É
            if (tabName !== 'friends') {
                document.getElementById('privateChat').style.display = 'none';
                document.getElementById('friendsList').style.display = 'block';
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function searchUsers() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length >= 2) {
                socket.emit('search_users', query);
            }
        }

        function sendFriendRequest(username) {
            socket.emit('send_friend_request', username);
            event.target.textContent = '‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω';
            event.target.disabled = true;
        }

        function acceptFriendRequest(fromUsername) {
            socket.emit('accept_friend_request', fromUsername);
        }

        function declineFriendRequest(fromUsername) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
            const requestsList = document.getElementById('requestsList');
            const requestElement = document.querySelector([data-request="${fromUsername}"]);
            if (requestElement) {
                requestElement.remove();
            }
        }

        function openPrivateChat(friend) {
            currentChat = friend.username;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
            document.getElementById('privateChat').style.display = 'flex';
            document.getElementById('friendsList').style.display = 'none';
            document.getElementById('chatWith').textContent = üí¨ –ß–∞—Ç —Å ${friend.username} ${friend.avatar};
            document.getElementById('privateMessages').innerHTML = '';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            socket.emit('load_chat_history', friend.username);
        }
function sendPrivateMessage() {
            const input = document.getElementById('privateMessageInput');
            const text = input.value.trim();
            
            if (text && currentChat) {
                socket.emit('private_message', { to: currentChat, text });
                input.value = '';
            }
        }

        function sendGlobalMessage() {
            const input = document.getElementById('globalMessageInput');
            const text = input.value.trim();
            
            if (text) {
                socket.emit('global_message', text);
                input.value = '';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.IO
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server');
        });

        socket.on('register_success', (data) => {
            currentUser = data.user;
            showApp();
        });

        socket.on('login_success', (data) => {
            currentUser = data.user;
            friends = data.friends || [];
            showApp();
            updateFriendsList(friends);
            updateRequestsList(data.friendRequests || []);
        });

        socket.on('register_error', (error) => {
            showError(error);
        });

        socket.on('login_error', (error) => {
            showError(error);
        });

        socket.on('search_results', (results) => {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="empty-state">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            container.innerHTML = results.map(user => 
                <div class="user-item">
                    <span class="user-avatar">${user.avatar}</span>
                    <span class="user-name">${user.username}</span>
                    <button onclick="sendFriendRequest('${user.username}')" 
                            style="margin-left: auto; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer;">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            ).join('');
        });

        socket.on('friend_request_sent', (username) => {
            console.log('‚úÖ –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', username);
        });

        socket.on('new_friend_request', (request) => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
            if (confirm(–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${request.from} ${request.fromAvatar} —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è. –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–ø—Ä–æ—Å–∞–º?)) {
                openTab('requests');
            }
            updateRequestsList([...getCurrentRequests(), request]);
        });

        socket.on('friend_added', (friend) => {
            friends.push(friend);
            updateFriendsList(friends);
        });

        socket.on('update_friends', (friendsList) => {
            friends = friendsList;
            updateFriendsList(friends);
        });

        socket.on('new_private_message', (message) => {
            addPrivateMessage(message);
        });

        socket.on('new_global_message', (message) => {
            addGlobalMessage(message);
        });

        socket.on('chat_history', (data) => {
            document.getElementById('privateMessages').innerHTML = '';
            data.messages.forEach(addPrivateMessage);
        });

        socket.on('error', (error) => {
            alert('–û—à–∏–±–∫–∞: ' + error);
        });

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userAvatar').textContent = currentUser.avatar;
        }

        function showError(message) {
            document.getElementById('authError').textContent = message;
        }
function updateFriendsList(friendsList) {
            const container = document.getElementById('friendsList');
            
            if (friendsList.length === 0) {
